<?php
/**
 * Finance Dashboard
 * Deliverance Church Management System
 * 
 * Main finance overview and statistics
 */

require_once '../../config/config.php';
require_once '../../includes/functions.php';

// Check authentication and permissions
requireLogin();
if (!hasPermission('finance')) {
    header('Location: ' . BASE_URL . 'modules/dashboard/');
    exit();
}

$page_title = 'Finance Dashboard';
$page_icon = 'fas fa-money-bill-wave';

// Get date range (default to current month)
$start_date = $_GET['start_date'] ?? date('Y-m-01');
$end_date = $_GET['end_date'] ?? date('Y-m-t');

try {
    $db = Database::getInstance();
    
    // Get financial summary for the period
    $income_stmt = $db->executeQuery("
        SELECT 
            COALESCE(SUM(amount), 0) as total_income,
            COUNT(*) as income_count
        FROM income 
        WHERE transaction_date BETWEEN ? AND ? 
        AND status = 'verified'
    ", [$start_date, $end_date]);
    $income_data = $income_stmt->fetch();
    
    $expense_stmt = $db->executeQuery("
        SELECT 
            COALESCE(SUM(amount), 0) as total_expenses,
            COUNT(*) as expense_count
        FROM expenses 
        WHERE expense_date BETWEEN ? AND ? 
        AND status = 'paid'
    ", [$start_date, $end_date]);
    $expense_data = $expense_stmt->fetch();
    
    // Calculate net income
    $net_income = $income_data['total_income'] - $expense_data['total_expenses'];
    
    // Get income by category
    $income_categories_stmt = $db->executeQuery("
        SELECT 
            ic.name,
            COALESCE(SUM(i.amount), 0) as amount,
            COUNT(i.id) as transaction_count
        FROM income_categories ic
        LEFT JOIN income i ON ic.id = i.category_id 
            AND i.transaction_date BETWEEN ? AND ? 
            AND i.status = 'verified'
        WHERE ic.is_active = 1
        GROUP BY ic.id, ic.name
        ORDER BY amount DESC
    ", [$start_date, $end_date]);
    $income_categories = $income_categories_stmt->fetchAll();
    
    // Get expense by category
    $expense_categories_stmt = $db->executeQuery("
        SELECT 
            ec.name,
            COALESCE(SUM(e.amount), 0) as amount,
            COUNT(e.id) as transaction_count
        FROM expense_categories ec
        LEFT JOIN expenses e ON ec.id = e.category_id 
            AND e.expense_date BETWEEN ? AND ? 
            AND e.status = 'paid'
        WHERE ec.is_active = 1
        GROUP BY ec.id, ec.name
        ORDER BY amount DESC
    ", [$start_date, $end_date]);
    $expense_categories = $expense_categories_stmt->fetchAll();
    
    // Get recent transactions
    $recent_income_stmt = $db->executeQuery("
        SELECT 
            i.transaction_id,
            i.amount,
            i.source,
            i.transaction_date,
            ic.name as category_name,
            i.status
        FROM income i
        JOIN income_categories ic ON i.category_id = ic.id
        ORDER BY i.created_at DESC
        LIMIT 5
    ");
    $recent_income = $recent_income_stmt->fetchAll();
    
    $recent_expenses_stmt = $db->executeQuery("
        SELECT 
            e.transaction_id,
            e.amount,
            e.description,
            e.expense_date,
            ec.name as category_name,
            e.status
        FROM expenses e
        JOIN expense_categories ec ON e.category_id = ec.id
        ORDER BY e.created_at DESC
        LIMIT 5
    ");
    $recent_expenses = $recent_expenses_stmt->fetchAll();
    
    // Get monthly trend data (last 6 months)
    $trend_stmt = $db->executeQuery("
        SELECT 
            DATE_FORMAT(month_year, '%Y-%m') as month,
            DATE_FORMAT(month_year, '%M %Y') as month_name,
            COALESCE(income_total, 0) as income,
            COALESCE(expense_total, 0) as expense
        FROM (
            SELECT DATE_FORMAT(CURDATE() - INTERVAL seq MONTH, '%Y-%m-01') as month_year
            FROM (SELECT 0 as seq UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5) as months
        ) months
        LEFT JOIN (
            SELECT 
                DATE_FORMAT(transaction_date, '%Y-%m') as month,
                SUM(amount) as income_total
            FROM income 
            WHERE status = 'verified' 
            AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
            GROUP BY DATE_FORMAT(transaction_date, '%Y-%m')
        ) income_data ON DATE_FORMAT(month_year, '%Y-%m') = income_data.month
        LEFT JOIN (
            SELECT 
                DATE_FORMAT(expense_date, '%Y-%m') as month,
                SUM(amount) as expense_total
            FROM expenses 
            WHERE status = 'paid' 
            AND expense_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
            GROUP BY DATE_FORMAT(expense_date, '%Y-%m')
        ) expense_data ON DATE_FORMAT(month_year, '%Y-%m') = expense_data.month
        ORDER BY month_year ASC
    ");
    $trend_data = $trend_stmt->fetchAll();
    
    // Get pending transactions
    $pending_income_count = getRecordCount('income', ['status' => 'pending']);
    $pending_expense_count = getRecordCount('expenses', ['status' => 'pending']);
    
} catch (Exception $e) {
    error_log("Finance dashboard error: " . $e->getMessage());
    $income_data = ['total_income' => 0, 'income_count' => 0];
    $expense_data = ['total_expenses' => 0, 'expense_count' => 0];
    $net_income = 0;
    $income_categories = [];
    $expense_categories = [];
    $recent_income = [];
    $recent_expenses = [];
    $trend_data = [];
    $pending_income_count = 0;
    $pending_expense_count = 0;
}

$breadcrumb = [
    ['title' => 'Finance Dashboard']
];

$page_actions = [
    [
        'title' => 'Add Income',
        'url' => 'add_income.php',
        'icon' => 'fas fa-plus-circle',
        'class' => 'success'
    ],
    [
        'title' => 'Add Expense',
        'url' => 'add_expense.php',
        'icon' => 'fas fa-minus-circle',
        'class' => 'danger'
    ],
    [
        'title' => 'View Reports',
        'url' => 'reports.php',
        'icon' => 'fas fa-chart-bar',
        'class' => 'info'
    ]
];

include '../../includes/header.php';
?>

<div class="container-fluid">
    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="<?php echo htmlspecialchars($start_date); ?>">
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="<?php echo htmlspecialchars($end_date); ?>">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-church-primary">
                                <i class="fas fa-filter me-2"></i>Filter
                            </button>
                            <a href="?" class="btn btn-secondary">
                                <i class="fas fa-refresh me-2"></i>Reset
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Financial Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card bg-gradient text-white" style="background: linear-gradient(135deg, #28a745, #20c997);">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-white bg-opacity-20">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="stats-number"><?php echo formatCurrency($income_data['total_income']); ?></div>
                        <div class="stats-label">Total Income</div>
                        <small class="opacity-75"><?php echo $income_data['income_count']; ?> transactions</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card bg-gradient text-white" style="background: linear-gradient(135deg, #dc3545, #fd7e14);">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-white bg-opacity-20">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="stats-number"><?php echo formatCurrency($expense_data['total_expenses']); ?></div>
                        <div class="stats-label">Total Expenses</div>
                        <small class="opacity-75"><?php echo $expense_data['expense_count']; ?> transactions</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card bg-gradient text-white" style="background: linear-gradient(135deg, <?php echo ($net_income >= 0) ? 'var(--church-blue), var(--church-blue-light)' : '#6c757d, #495057'; ?>);">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-white bg-opacity-20">
                        <i class="fas fa-<?php echo ($net_income >= 0) ? 'chart-line' : 'chart-line-down'; ?>"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="stats-number"><?php echo formatCurrency($net_income); ?></div>
                        <div class="stats-label">Net Income</div>
                        <small class="opacity-75"><?php echo ($net_income >= 0) ? 'Surplus' : 'Deficit'; ?></small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card bg-gradient text-white" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-white bg-opacity-20">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="stats-number"><?php echo $pending_income_count + $pending_expense_count; ?></div>
                        <div class="stats-label">Pending Transactions</div>
                        <small class="opacity-75"><?php echo $pending_income_count; ?> income, <?php echo $pending_expense_count; ?> expenses</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Monthly Trend Chart -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Income vs Expenses Trend (Last 6 Months)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Income Categories Pie Chart -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Income by Category
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="incomePieChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Income and Expense Categories -->
    <div class="row mb-4">
        <!-- Income Categories -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-arrow-up text-success me-2"></i>Income Categories
                    </h5>
                    <a href="income.php" class="btn btn-sm btn-outline-success">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-center">Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (empty($income_categories)): ?>
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <i class="fas fa-info-circle me-2"></i>No income data for selected period
                                        </td>
                                    </tr>
                                <?php else: ?>
                                    <?php foreach ($income_categories as $category): ?>
                                        <tr>
                                            <td>
                                                <strong><?php echo htmlspecialchars($category['name']); ?></strong>
                                            </td>
                                            <td class="text-end">
                                                <span class="text-success fw-bold">
                                                    <?php echo formatCurrency($category['amount']); ?>
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-light text-dark">
                                                    <?php echo number_format($category['transaction_count']); ?>
                                                </span>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Expense Categories -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-arrow-down text-danger me-2"></i>Expense Categories
                    </h5>
                    <a href="expenses.php" class="btn btn-sm btn-outline-danger">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-center">Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (empty($expense_categories)): ?>
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <i class="fas fa-info-circle me-2"></i>No expense data for selected period
                                        </td>
                                    </tr>
                                <?php else: ?>
                                    <?php foreach ($expense_categories as $category): ?>
                                        <tr>
                                            <td>
                                                <strong><?php echo htmlspecialchars($category['name']); ?></strong>
                                            </td>
                                            <td class="text-end">
                                                <span class="text-danger fw-bold">
                                                    <?php echo formatCurrency($category['amount']); ?>
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-light text-dark">
                                                    <?php echo number_format($category['transaction_count']); ?>
                                                </span>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions -->
    <div class="row">
        <!-- Recent Income -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle text-success me-2"></i>Recent Income
                    </h5>
                    <a href="income.php" class="btn btn-sm btn-outline-success">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Source</th>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (empty($recent_income)): ?>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-info-circle me-2"></i>No recent income transactions
                                        </td>
                                    </tr>
                                <?php else: ?>
                                    <?php foreach ($recent_income as $transaction): ?>
                                        <tr>
                                            <td>
                                                <code><?php echo htmlspecialchars($transaction['transaction_id']); ?></code>
                                            </td>
                                            <td>
                                                <strong><?php echo htmlspecialchars($transaction['source'] ?: 'Not specified'); ?></strong>
                                                <br>
                                                <small class="text-muted"><?php echo formatDisplayDate($transaction['transaction_date']); ?></small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    <?php echo htmlspecialchars($transaction['category_name']); ?>
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <strong class="text-success">
                                                    <?php echo formatCurrency($transaction['amount']); ?>
                                                </strong>
                                            </td>
                                            <td>
                                                <?php
                                                $status_class = [
                                                    'pending' => 'warning',
                                                    'verified' => 'success',
                                                    'rejected' => 'danger'
                                                ];
                                                $class = $status_class[$transaction['status']] ?? 'secondary';
                                                ?>
                                                <span class="badge bg-<?php echo $class; ?>">
                                                    <?php echo ucfirst($transaction['status']); ?>
                                                </span>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Expenses -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-minus-circle text-danger me-2"></i>Recent Expenses
                    </h5>
                    <a href="expenses.php" class="btn btn-sm btn-outline-danger">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (empty($recent_expenses)): ?>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-info-circle me-2"></i>No recent expense transactions
                                        </td>
                                    </tr>
                                <?php else: ?>
                                    <?php foreach ($recent_expenses as $transaction): ?>
                                        <tr>
                                            <td>
                                                <code><?php echo htmlspecialchars($transaction['transaction_id']); ?></code>
                                            </td>
                                            <td>
                                                <strong><?php echo htmlspecialchars(truncateText($transaction['description'], 30)); ?></strong>
                                                <br>
                                                <small class="text-muted"><?php echo formatDisplayDate($transaction['expense_date']); ?></small>
                                            </td>
                                            <td>
                                                <span class="badge bg-warning">
                                                    <?php echo htmlspecialchars($transaction['category_name']); ?>
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <strong class="text-danger">
                                                    <?php echo formatCurrency($transaction['amount']); ?>
                                                </strong>
                                            </td>
                                            <td>
                                                <?php
                                                $status_class = [
                                                    'pending' => 'warning',
                                                    'approved' => 'info',
                                                    'paid' => 'success',
                                                    'rejected' => 'danger'
                                                ];
                                                $class = $status_class[$transaction['status']] ?? 'secondary';
                                                ?>
                                                <span class="badge bg-<?php echo $class; ?>">
                                                    <?php echo ucfirst($transaction['status']); ?>
                                                </span>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendData = <?php echo json_encode($trend_data); ?>;
    
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: trendData.map(item => item.month_name),
            datasets: [{
                label: 'Income',
                data: trendData.map(item => parseFloat(item.income)),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Expenses',
                data: trendData.map(item => parseFloat(item.expense)),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value, index, values) {
                            return 'Ksh ' + value.toLocaleString();
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // Income Categories Pie Chart
    const incomePieCtx = document.getElementById('incomePieChart').getContext('2d');
    const incomeCategories = <?php echo json_encode($income_categories); ?>;
    
    // Filter out categories with zero amounts and limit to top 5
    const filteredCategories = incomeCategories
        .filter(cat => parseFloat(cat.amount) > 0)
        .slice(0, 5);
    
    if (filteredCategories.length > 0) {
        new Chart(incomePieCtx, {
            type: 'doughnut',
            data: {
                labels: filteredCategories.map(cat => cat.name),
                datasets: [{
                    data: filteredCategories.map(cat => parseFloat(cat.amount)),
                    backgroundColor: [
                        '#28a745',
                        '#17a2b8',
                        '#ffc107',
                        '#fd7e14',
                        '#6f42c1'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = 'Ksh ' + context.parsed.toLocaleString();
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    } else {
        // Show no data message
        const canvas = document.getElementById('incomePieChart');
        const ctx = canvas.getContext('2d');
        ctx.font = '16px Arial';
        ctx.fillStyle = '#6c757d';
        ctx.textAlign = 'center';
        ctx.fillText('No income data available', canvas.width / 2, canvas.height / 2);
    }
});
</script>

<?php include '../../includes/footer.php'; ?>